---
title: "seurat_mapping_for_cross_species"
author: "Beth Moore"
date: "2023-07-18"
output: html_document
---
# Seurat tansfer mapping for cross species analysis
# do preprocessing on human and pig data (preprocess_crossspecies.Rmd)
# both reference and query should undergo normalization and find variable features,
# then only reference is scaled and undegoes dimentionality reduction

# Load libraries, set wd, and source functions
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# set Rterm: /w5home/bmoore/miniconda3/envs/scRNAseq_best/bin/R
#conda upgrade -c conda-forge --all
#BiocManager::install(version = "3.18")
#BiocManager::install("ComplexHeatmap")
library(dplyr)
library(Seurat)
library(patchwork)
library(scran)
library(BiocParallel)
library(DropletUtils)
library(cowplot)
library(harmony)
library(reticulate)
library(purrr)
library(jsonlite)
library(rmarkdown)
library(ggplot2)
library(scPred)
library(ComplexHeatmap)
library(circlize)
library(colorspace)
library(GetoptLong)
# set variables
WD <- "/w5home/bmoore/scRNAseq/GAMM/human_data/cowan_cell_2020/"
GIT_DIR <- "/w5home/bmoore/scRNAseq_downstream/"
REF.SEURAT <- "output_preprocess_test_20240209_145813/human_F49i-N-B7_clustered.rds"
QUERY.SEURAT <- "output_preprocess_test_20240209_145813/querygamm.data.S2_clustered.rds"
# set up environment and output
use_condaenv("scRNAseq_best", required=TRUE)
setwd(WD)
timestamp <- format(Sys.time(), "%Y%m%d_%H%M%S")
output <- paste0("output_seurat_mapping_", timestamp)
dir.create(output, showWarnings = FALSE)
file.copy(paste0(GIT_DIR,"config.json"), file.path(output, "config.json"))
config <- fromJSON(file.path(output, "config.json"))
output <- paste0(output, "/")
source(paste0(GIT_DIR,"src/sc_pipeline_functions.R"))
```

# read in seurat objects that were preprocessed
```{r read_data}
query.seurat <- readRDS(file = QUERY.SEURAT)
ref.seurat <- readRDS(file = REF.SEURAT)
```
# get metadata- if needed
```{r metadata}
# get metadata if cell type annotation is needed 
# set type "ref" or "query" ref= metadata.file1, query= metadata.file2
ref.seurat <- get_metadata(ref.seurat, "ref")
query.seurat <- get_metadata(query.seurat, "query")
print(colnames(ref.seurat@meta.data))
print(colnames(query.seurat@meta.data))
```

# some visualizations
```{r visuals}
# feature plots
count_and_feature_plots(ref.seurat,query.seurat)
```
# ref umap and subset metadata
```{r subset_metadata}
ref.seurat.sub <- visualize_and_subset_ref(ref.seurat)
```

# mapping and annotating query datasets
```{r find_anchors_and_transfer}
obj.list <- transfer_anchors(ref.seurat.sub, query.seurat)
print(obj.list)
query.seurat <- obj.list[[1]]
anchors <- obj.list[[2]]
```


# projection of a query onto the reference UMAP structure.
```{r project_query_on_ref}
obj.list <- project_query_on_ref(ref.seurat.sub, query.seurat, anchors)
ref.seurat <- obj.list[[1]]
query.seurat <- obj.list[[2]]
```
b
# visualize probabilities
```{r visualize_prob}
#  probabilities of each cell in the @meta.data slot of the query Seurat object.
# get labels
labels<- as.vector(unique(colnames(query.seurat@meta.data)))
library(stringr)
labels <- labels[startsWith(labels, "prediction.score.")]
labels<-labels[! labels %in% c('prediction.score.max')]
# visualize the probabilities over the UMAP plot:
pdf(paste0(output, "query_celltype_prediction_featureplot.pdf"), width = 10, height = 10)
print(FeaturePlot(query.seurat, labels, keep.scale = "all"))
dev.off()
```
# get comparison between predicted and manual annotations
```{r get_comparison}
query.ref.data.table <- get_manual_comparison(query.seurat)
print(query.ref.data.table)
```

# make heatmap
```{r heatmap}
hm <- heatmap_func(query.ref.data.table)
```
```{r save_data}
saveRDS(query.seurat, file= paste0(output,"query_seurat_pred.rds"))
saveRDS(ref.seurat, file= paste0(output,"human_seurat_map.rds"))
```
# save session info
```{r sessioninfo}
writeLines(capture.output(sessionInfo()), paste0(output,"sessionInfo.txt"))
```
```{r read_data}
#gamms2 <- readRDS(file = "/w5home/bmoore/scRNAseq/GAMM/human_data/reh_cellrep_2020/output_seurat_mapping_20230804_143108/gamms2_rpca_pred.rds")
```