# load packages
```{r load_packages}
# conda env scRNAseq_new
library(Seurat)
library(SeuratData)
library(patchwork)
library(scran)
library(BiocParallel)
library(cowplot)
library(reticulate)
library(purrr)
library(jsonlite)
library(rmarkdown)
library(ggplot2)
library(scater)
library(SingleCellExperiment)
library(tidyverse)
```
# set dir and filenames
```{r dir_file}
GIT_DIR <- "/w5home/bmoore/scRNAseq_downstream/src/" #getwd()
DATA_DIR <- "/w5home/bmoore/Pierre_sc_zebrafish/"
filename <- "SCI6WK_PARSE_PG_SB_030123.rds"
setwd(DATA_DIR)
```
# read in
```{r readin_merged}
merged_seurat <- readRDS(file = paste0(DATA_DIR, filename))
print(merged_seurat)
colnames(merged_seurat@meta.data)
```
# get metadata for cell types
```{r metadata}
clusterids <- read.csv(paste0(DATA_DIR, "celltype_annot_df.csv"), header = TRUE)
print(clusterids)
new_df_ordered <- clusterids[order(as.numeric(clusterids$Cluster)), ]
new_cluster_ids <- new_df_ordered$Celltype
print(new_cluster_ids)
# make sure that idents are the clusters you want annotated
merged_seurat <- SetIdent(merged_seurat, value = "seurat_clusters")
# Rename the clusters based on the new IDs
names(new_cluster_ids) <- levels(merged_seurat)
merged_seurat <- RenameIdents(merged_seurat, new_cluster_ids)
# put in CellType metadata
merged_seurat$CellType <- Idents(merged_seurat)

# Generate and plot the UMAP plot
# pdf(paste0(DATA_DIR, "labeled-clusters.pdf"), bg = "white")
# print(DimPlot(merged_seurat, reduction = "umap", label = TRUE, 
#         pt.size = 0.5, group.by = "CellType"))
# dev.off()
```
# Pseudobulk analysis
```{r pseudobulk}
# pseudobulk cells by stimulation condition AND cell type
bulk_seurat <- AggregateExpression(merged_seurat, assays = "RNA", 
                                group.by = c("Type", "orig.ident","CellType"), 
                                return.seurat = TRUE) #, layer = "counts"
Cells(bulk_seurat)
# make new celltype column
bulk_seurat$celltype.comp <- paste(bulk_seurat$CellType, bulk_seurat$Type, sep = "_")
Idents(bulk_seurat) <- "celltype.comp"
unique(bulk_seurat$celltype.comp)
```
# modify expression matrix function
```{r}
modify_matrix <- function(df){
  
  # Get the rownames (sample names)
  sample_names <- rownames(df)

  # Split by "_" and convert to a data.frame
  split_names <- do.call(rbind, strsplit(sample_names, "_"))

  # Assign to new columns in your dataframe
  df$timepoint <- split_names[,1]
  df$rep       <- split_names[,2]
  df$celltype  <- split_names[,3]

  # split to get recovered/ not recovered
  R.NR.type <- do.call(rbind, strsplit(df$timepoint, "-"))[,2]
  timepoint <- do.call(rbind, strsplit(df$timepoint, "-"))[,1]
  timepoint <- ifelse(
    tolower(timepoint) == "sham",
    "0Wk",
    sub("^g(\\d+)Wk$", "\\1Wk", timepoint)
  )
  R.NR.type <- ifelse(
     R.NR.type %in% c("Sham", "g1Wk"), NA, R.NR.type)

  df$type <- R.NR.type
  df$timepoint <- timepoint

  # sort
  df <- df %>%
    arrange(timepoint)
  
  return(df)
}
```

```{r}
# Function to duplicate a given timepoint's NA row for each type
duplicate_timepoint_for_types <- function(df, tp, types) {
  rows <- df %>% filter(timepoint == tp & is.na(type))
  if (nrow(rows) == 0) return(NULL)
  expanded <- rows[rep(1, length(types)), ]
  expanded$type <- types
  expanded
}
```

# summarize function
```{r}
summarise_gene <- function(dfsub){
  # get mean, min, max
  dfsub$rep <- as.numeric(as.character(dfsub$rep))

  # Summarize by timepoint and type
  df_summary <- dfsub %>%
    group_by(timepoint, type) %>%
    summarise(
    mean.expr = mean(norm.expr, na.rm = TRUE),
    min.rep = min(norm.expr, na.rm = TRUE),
    max.rep = max(norm.expr, na.rm = TRUE),
    .groups = "drop"
  )
  # Join summary back to dfsub if you want these columns in the original dfsub
  dfsub <- left_join(dfsub, df_summary, by = c("timepoint", "type")) 

  # Identify all types to connect (e.g., NR, R)
  types_to_connect <- unique(df_summary$type[!is.na(df_summary$type)])

  # Duplicate for 0Wk and 1Wk
  zerowk_expanded <- duplicate_timepoint_for_types(df_summary, "0Wk", types_to_connect)
  onewk_expanded  <- duplicate_timepoint_for_types(df_summary, "1Wk", types_to_connect)

  # Combine everything
  df_summary_connected <- df_summary %>%
    filter(!(timepoint %in% c("0Wk", "1Wk") & is.na(type))) %>%
    bind_rows(zerowk_expanded, onewk_expanded) %>%
    arrange(timepoint)

  return(df_summary_connected)
}
```
# plot function
```{r}
plot_function <- function(df_summary_connected, gene, Celltype, timept) {

  p1 <- ggplot(data = df_summary_connected, aes(x = timepoint, 
        y = mean.expr, group = type, color = type)) +
  geom_line(aes(color=type)) +
  geom_point() +
  geom_errorbar(aes(ymin = min.rep, ymax = max.rep), width = 0.1) + 
    theme_minimal() + labs(title = paste0(gene, " ", Celltype), x="Time point", 
    y = "Mean normalized expr")

  # make pdf
  pdf(file=paste0(DATA_DIR, gene, "_", Celltype, "_", timept, "_expr_lineplot",
                ".pdf"),
        height=4, width=5)
  print(p1)
  dev.off()
}
```

# loop through DE files
```{r}
# need to loop through DE files here
de_dir <- file.path(DATA_DIR, "DE_genes")
filelist <- list.files(path = de_dir, pattern = "_DE_genes\\.txt$", full.names = TRUE)
for (f in filelist) {
  fname <- basename(f)
  fname_core <- sub("_DE_genes\\.txt$", "", fname)
  parts <- strsplit(fname_core, "_")[[1]]
  celltype_part <- paste(parts[1:(length(parts)-1)], collapse = "_")
  comparison <- parts[length(parts)]
  
  # Extract timepoint from celltype if present (e.g., "Macrophages6Wk")
  # This regex looks for a timepoint at the end of the celltype (e.g., "6Wk")
  timepoint_match <- regmatches(celltype_part, regexpr("[0-9]+Wk$", celltype_part))
  timepoint <- ifelse(length(timepoint_match) > 0, timepoint_match, "1Wk-Sham")
  
  # Remove the timepoint from the celltype if it was found
  Celltype <- ifelse(!is.na(timepoint),
                     sub("[0-9]+Wk$", "", celltype_part),
                     celltype_part)
  
  # Read the file (adjust sep if needed)
  de_df <- read.table(f, header = TRUE, sep = " ", stringsAsFactors = FALSE)
  
  print(paste("Celltype:", Celltype, "Timepoint:", timepoint, "Comparison:", comparison))

  # get top DE genes by adj pval
  # sort
  de_df <- de_df %>%
    arrange(p_val_adj)
  #print(head(de_df))
  # subset
  if(nrow(de_df) < 10){
    if(dim(de_df)[1] == 0){
      de_df_sub <- NULL
    } else {
      n <- nrow(de_df)
      de_df_sub <- de_df[1:n,]
    }
  } else {
    de_df_sub <- de_df[1:10,]
  }
  if (is.null(de_df_sub)){
    print(paste0("No DE genes for ", Celltype, " ", timepoint))
  } else {
    # get genes
    gene.vector <- rownames(de_df_sub)
    #print(gene.vector)
    gene.matrix <- bulk_seurat[["RNA"]]$counts[gene.vector,]
    
    # format data
    if (length(gene.vector) == 1){
      gene.matrix <- as.data.frame(gene.matrix)
      colnames(gene.matrix) <- gene.vector[1]
    } else {
      gene.matrix <- as.data.frame(t(gene.matrix))
    }
    colnames(gene.matrix)
    df <- modify_matrix(gene.matrix)

    # loop through genes
    for(g in 1:length(gene.vector)){
      gene <- gene.vector[g]
      print(gene)
      # subset for gene and cell type
      dfsub <- df[,c(gene,"timepoint","rep","celltype","type")]
      #print(head(dfsub))
      dfsub <- subset(x = dfsub, celltype %in% Celltype)
      colnames(dfsub) <- c("norm.expr","timepoint","rep","celltype","type")
      # summarise expression values
      df_summary <- summarise_gene(dfsub)
      # write summary
      write.csv(df_summary, file = paste0("summary_", 
        gene, "_", Celltype, timepoint, ".csv"), sep=",")
      # plot summary
      plot_function(df_summary, gene, Celltype, timepoint)
    }
  }
}
```
```{r}
gene.vector <- c("ANO1", "GLULB", "ENSDARG00000109963", "PKD1B", "GFAP", "SLC2A1B", "MYH11A", "ABCA1A", "ARHGEF4", "BCL2A")
gene.matrix <- bulk_seurat[["RNA"]]$counts[gene.vector,]
head(gene.matrix)
colnames(gene.matrix)
```
# loop through all celltypes for all timepoints to get expression and visualize
```{r}
celltypes <- unique(bulk_seurat$CellType)
timepoints <- unique(bulk_seurat$Type)

```
