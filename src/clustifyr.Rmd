---
title: "clustifyr"
author: "Beth Moore"
date: "2023-09-22"
output: html_document
---

# clustifyr analysis for automatic cell type annotation with marker list or reference
# To run clustifyr, you need clustered seurat object

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#### installations ####
# see scRNAseq_library/src/clustifyr_setup.sh or
# use create conda environment with environment_scRNAseq-clustifyr.yml
# 

### load libraries ###
library(reticulate)
use_condaenv("/w5home/bmoore/miniconda3/envs/scRNAseq_best")
library(clustifyr)
library(ggplot2)
library(cowplot)
library(Seurat)
library(ComplexHeatmap)
library(rmarkdown)
### set variables ###
WD <- "/w5home/bmoore/scRNAseq/GAMM/human_data/reh_cellrep_2020/"
GIT_DIR <- "/w5home/bmoore/scRNAseq_downstream/"
REF.SEURAT <- "output_seurat_mapping_20240125_112552/human_D205_subset_annot.rds" # if NA, only marker list is used
QUERY.SEURAT <- "output_seurat_mapping_20240125_112552/gamms2_cca_pred.rds"
### set working directory and output ###
setwd(WD)
timestamp <- format(Sys.time(), "%Y%m%d_%H%M%S")
output <- paste0("output_clustifyr_", timestamp)
dir.create(output, showWarnings = FALSE)
output <- paste0(output, "/")
## copy config to output
file.copy(paste0(GIT_DIR,"config.json"), file.path(output, "config.json"))
## source config and functions
config <- fromJSON(file.path(output, "config.json"))
source(paste0(GIT_DIR,"src/sc_pipeline_functions.R"))
```
# load data set and marker list
```{r load_data}
# load data set
seurat.obj <- readRDS(file = QUERY.SEURAT)
# load reference
if(REF.SEURAT!="NA"){
ref.seurat<- readRDS(file = REF.SEURAT)
} else {
  print("No reference, using marker list only")
}
# load marker list
markers <- read.csv2(MARKER_PATH, sep="\t", header = TRUE)
```
# rename identities if necessary
```{r rename_idents}
# check metadata
colnames(seurat.obj@meta.data)
# remove NAs
seurat.obj<- subset(seurat.obj, subset = seurat_clusters != "NA")
# convert to character
seurat.obj$seurat_clusters <- as.character(seurat.obj$seurat_clusters)
```

# run clustifyr from marker list
```{r clustifyr}
# convert to single cell experiment
SCE <- as.SingleCellExperiment(seurat.obj)
# run clustifyr
seurat.obj<- annotate_with_clustifyR(seurat.obj, SCE, output)
```

# run clustifyr with references
```{r clustifyr_ref}
if(REF.SEURAT!="NA"){
  
  #visualize and subset
  ref.seurat.sub <- visualize_and_subset_ref(ref.seurat, output)
  # annotate with clustifyr
  clustifyr.obj <- annotate_with_clustifyR_ref(ref.seurat.sub, seurat.obj, SCE, output)

} else {
  print("no references, quitting")
  q()
}
```
